<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Crop Advisor - AI-Powered Agricultural Intelligence</title>
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    <div class="container">
        <header>
            <h1>üåæ YieldWise</h1>
            <p>AI-Powered Agricultural Intelligence Platform</p>
        </header>

        <div class="card" id="location-card">
            <h3>üìç Select Location</h3>
            
            <div class="form-group">
                <label for="location-search">Search Location</label>
                <div class="location-search-container">
                    <input type="text" id="location-search" placeholder="Enter city name, pin code, or address..." />
                    <button type="button" id="current-location-btn" title="Use Current Location">üìç</button>
                </div>
                <div id="location-suggestions" class="location-suggestions hidden"></div>
            </div>

            <div id="map-container" class="map-container">
                <div id="map"></div>
            </div>

            <div id="selected-location" class="selected-location hidden">
                <strong>Selected Location:</strong> <span id="location-name">Not selected</span>
                <br>
                <small>Coordinates: <span id="location-coords">N/A</span></small>
                <small class="location-state-info hidden">State: <span id="location-state">N/A</span></small>
            </div>
        </div>

        <div class="card">
            <h3>üå± Crop Yield Prediction</h3>
            
            <form id="prediction-form">
                <div class="grid-container">
                    <div class="form-group">
                        <label for="crop">Crop Type</label>
                        <select id="crop" required>
                            <option value="">Select Crop</option>
                            <option value="Rice">Rice</option>
                            <option value="Wheat">Wheat</option>
                            <option value="Maize">Maize</option>
                            <option value="Cotton">Cotton</option>
                            <option value="Sugarcane">Sugarcane</option>
                            <option value="Groundnut">Groundnut</option>
                            <option value="Bajra">Bajra</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="season">Season</label>
                        <select id="season" required>
                            <option value="">Select Season</option>
                            <option value="Kharif">Kharif</option>
                            <option value="Rabi">Rabi</option>
                            <option value="Summer">Summer</option>
                            <option value="Whole Year">Whole Year</option>
                        </select>
                    </div>

                    </div>

                <div class="grid-container number-inputs">
                    <div class="form-group">
                        <label for="area">Area (hectares)</label>
                        <input type="number" id="area" min="0.1" step="0.1" required>
                    </div>

                    <div class="form-group">
                        <label for="rainfall">Annual Rainfall (mm)</label>
                        <input type="number" id="rainfall" min="0" step="1" required>
                    </div>

                    <div class="form-group">
                        <label for="fertilizer">Fertilizer (kg/ha)</label>
                        <input type="number" id="fertilizer" min="0" step="1" required>
                    </div>

                    <div class="form-group">
                        <label for="pesticide">Pesticide (kg/ha)</label>
                        <input type="number" id="pesticide" min="0" step="0.1" required>
                    </div>
                </div>

                <button type="submit" id="predict-btn">üîÆ Predict Crop Yield</button>
            </form>
        </div>

        <div class="card weather-section" id="weather-section">
            <h3>üå§Ô∏è Weather Forecast</h3>
            <p>Select a location to view weather forecast</p>
            <button type="button" id="weather-btn" class="hidden">Get Weather Forecast</button>
            <div id="weather-results" class="hidden"></div>
        </div>

        <div id="results-container" class="hidden">
            <div class="card" id="prediction-card">
                <h3>üéØ Yield Prediction Results</h3>
                <div class="prediction-main">
                    <div class="yield-value" id="yield-value">--</div>
                    <div class="yield-details">
                        <p><strong>Predicted Yield:</strong> <span id="yield-amount">--</span> tons/hectare</p>
                        <p><strong>Confidence Range:</strong> <span id="confidence-range">--</span></p>
                        <p><strong>Total Production:</strong> <span id="total-production">--</span> tons</p>
                    </div>
                </div>
            </div>

            <div class="card" id="recommendations-section">
                <h3>ü§ñ AI-Powered Recommendations</h3>
                <div id="recommendations-content">
                    <div class="warning-box">
                        <p>ü§ñ AI recommendations are not available. Ensure the server is configured with a valid Gemini API key.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="hidden">
            <div class="loader-container">
                <div class="loader"></div>
                <p>Analyzing data and consulting AI...</p>
            </div>
        </div>
    </div>

    <footer class="py-4 px-4">
        <div class="container mx-auto">
            <div class="flex flex-wrap justify-around items-center gap-8">

                <!-- Link 1: Yield Predictor -->
                <a href="#" class="flex flex-col items-center w-24 text-center text-gray-600 hover:text-gray-900 transition-colors duration-300 ease-in-out">
                    <span class="text-3xl mb-2">üåæ</span>
                    <span class="text-sm font-medium">Yield Predictor</span>
                </a>

                <!-- Link 2: Financial Predictor -->
                <a href="#" class="flex flex-col items-center w-24 text-center text-gray-600 hover:text-gray-900 transition-colors duration-300 ease-in-out">
                    <span class="text-3xl mb-2">üí∞</span>
                    <span class="text-sm font-medium">Financial Predictor</span>
                </a>

                <!-- Link 3: Disease Prediction -->
                <a href="#" class="flex flex-col items-center w-24 text-center text-gray-600 hover:text-gray-900 transition-colors duration-300 ease-in-out">
                    <span class="text-3xl mb-2">üî¨</span>
                    <span class="text-sm font-medium">Disease Prediction</span>
                </a>

                <!-- Link 4: Dashboard -->
                <a href="#" class="flex flex-col items-center w-24 text-center text-gray-600 hover:text-gray-900 transition-colors duration-300 ease-in-out">
                    <span class="text-3xl mb-2">üìä</span>
                    <span class="text-sm font-medium">Dashboard</span>
                </a>

            </div>
            
        </div>
    </footer>
    <script>
        // Configuration
        const MAPBOX_ACCESS_TOKEN = '{{ mapbox_key }}';
        
        // Global variables
        let map;
        let currentLocationMarker;
        let selectedCoordinates = null;
        let selectedLocationName = '';
        let selectedState = ''; // New variable to store the state

        // Initialize map
        function initializeMap() {
            if (!MAPBOX_ACCESS_TOKEN || MAPBOX_ACCESS_TOKEN === 'YOUR_MAPBOX_ACCESS_TOKEN') {
                document.getElementById('map-container').innerHTML = '<div class="error-box"><p>Please configure Mapbox API key to enable map functionality</p></div>';
                return;
            }

            mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-streets-v12',
                center: [78.9629, 20.5937], // India center
                zoom: 4
            });

            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl());

            // Handle map click
            map.on('click', function(e) {
                const coords = [e.lngLat.lng, e.lngLat.lat];
                setLocationFromCoordinates(coords);
                reverseGeocode(e.lngLat.lat, e.lngLat.lng);
            });
        }

        // Set location from coordinates
        function setLocationFromCoordinates(coords) {
            selectedCoordinates = coords;
            
            // Remove existing marker
            if (currentLocationMarker) {
                currentLocationMarker.remove();
            }

            // Add new marker
            currentLocationMarker = new mapboxgl.Marker({color: '#FF6B6B'})
                .setLngLat(coords)
                .addTo(map);

            // Fly to location
            map.flyTo({
                center: coords,
                zoom: 12
            });

            // Update display
            document.getElementById('location-coords').textContent = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
            document.getElementById('selected-location').classList.remove('hidden');

            // Show weather button
            document.getElementById('weather-btn').classList.remove('hidden');
            document.querySelector('#weather-section p').classList.add('hidden');
        }

        // Location search functionality
        function setupLocationSearch() {
            const searchInput = document.getElementById('location-search');
            const suggestionsDiv = document.getElementById('location-suggestions');
            const currentLocationBtn = document.getElementById('current-location-btn');

            let searchTimeout;

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 3) {
                    suggestionsDiv.classList.add('hidden');
                    return;
                }

                searchTimeout = setTimeout(() => {
                    searchLocations(query);
                }, 300);
            });

            // Current location button
            currentLocationBtn.addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const coords = [position.coords.longitude, position.coords.latitude];
                            setLocationFromCoordinates(coords);
                            reverseGeocode(position.coords.latitude, position.coords.longitude);
                        },
                        function(error) {
                            alert('Error getting location: ' + error.message);
                        }
                    );
                } else {
                    alert('Geolocation is not supported by this browser.');
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!suggestionsDiv.contains(e.target) && e.target !== searchInput) {
                    suggestionsDiv.classList.add('hidden');
                }
            });
        }

        // Search for locations using Mapbox Geocoding via our backend
        async function searchLocations(query) {
            try {
                const response = await fetch('/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();
                
                if (data.results) {
                    displayLocationSuggestions(data.results);
                } else {
                    document.getElementById('location-suggestions').innerHTML = `<div class="suggestion-item">No results found</div>`;
                    document.getElementById('location-suggestions').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Location search error:', error);
                document.getElementById('location-suggestions').innerHTML = `<div class="suggestion-item error-text">Error searching locations.</div>`;
                document.getElementById('location-suggestions').classList.remove('hidden');
            }
        }

        // Display location suggestions
        function displayLocationSuggestions(results) {
            const suggestionsDiv = document.getElementById('location-suggestions');
            suggestionsDiv.innerHTML = '';
            
            results.forEach(result => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = result.place_name;
                
                suggestionItem.addEventListener('click', function() {
                    selectLocation(result);
                });
                
                suggestionsDiv.appendChild(suggestionItem);
            });
            
            suggestionsDiv.classList.remove('hidden');
        }

        // Select a location from suggestions
        function selectLocation(location) {
            // Update input and hide suggestions
            document.getElementById('location-search').value = location.place_name;
            document.getElementById('location-suggestions').classList.add('hidden');
            
            // Update map and display
            setLocationFromCoordinates(location.coordinates);
            document.getElementById('location-name').textContent = location.place_name;
            
            // Extract state from context
            const stateComponent = location.context.find(c => c.id.startsWith('region.'));
            selectedState = stateComponent ? stateComponent.text : 'Unknown State';
            document.getElementById('location-state').textContent = selectedState;
            document.querySelector('.location-state-info').classList.remove('hidden');
        }

        // Reverse geocode coordinates to get location name and state via our backend
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch('/reverse-geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: lat, lon: lon })
                });

                const data = await response.json();
                
                if (data.place_name) {
                    document.getElementById('location-name').textContent = data.place_name;
                    document.getElementById('location-search').value = data.place_name;
                    
                    // Attempt to extract state from the place_name or context if available
                    // This is a common heuristic, might need refinement based on Mapbox's exact output
                    const parts = data.place_name.split(',').map(s => s.trim());
                    // Heuristic: often the second or third part after city/town is the state
                    selectedState = 'Unknown State';
                    if (parts.length > 1) {
                         // Look for common Indian states or try to extract from a broader context
                        const potentialState = parts[parts.length - 2]; // e.g., "Delhi, India" or "Mumbai, Maharashtra, India"
                        if (potentialState && potentialState.length > 2 && !/\d/.test(potentialState)) { // rudimentary check for valid state
                             selectedState = potentialState;
                        } else if (parts.length > 2) {
                            const anotherPotential = parts[parts.length - 3];
                            if (anotherPotential && anotherPotential.length > 2 && !/\d/.test(anotherPotential)) {
                                selectedState = anotherPotential;
                            }
                        }
                    }

                    // A more robust way might be to add logic in app.py to parse Mapbox's 'context' and return state explicitly
                    // For now, this client-side heuristic is a start.
                    document.getElementById('location-state').textContent = selectedState;
                    document.querySelector('.location-state-info').classList.remove('hidden');

                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                document.getElementById('location-name').textContent = 'Could not determine location name.';
                document.getElementById('location-state').textContent = 'Unknown State';
                document.querySelector('.location-state-info').classList.add('hidden');
            }
        }

        // Weather functionality
        async function getWeatherForecast() {
            if (!selectedCoordinates) {
                alert('Please select a location first');
                return;
            }

            const weatherBtn = document.getElementById('weather-btn');
            const weatherResults = document.getElementById('weather-results');
            
            weatherBtn.textContent = 'Loading...';
            weatherBtn.disabled = true;
            weatherResults.classList.add('hidden');


            try {
                const response = await fetch('/weather', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: selectedCoordinates[1],
                        lon: selectedCoordinates[0]
                    })
                });

                const data = await response.json();
                
                if (data.forecast) {
                    displayWeatherForecast(data.forecast, data.location);
                } else {
                    weatherResults.innerHTML = `<div class="error-box"><p>${data.error || 'Failed to fetch weather data'}</p></div>`;
                    weatherResults.classList.remove('hidden');
                }
            } catch (error) {
                weatherResults.innerHTML = `<div class="error-box"><p>Error fetching weather: ${error.message}</p></div>`;
                weatherResults.classList.remove('hidden');
            } finally {
                weatherBtn.textContent = 'Refresh Weather Forecast';
                weatherBtn.disabled = false;
            }
        }

        // Display weather forecast
        function displayWeatherForecast(forecast, location) {
            const weatherResults = document.getElementById('weather-results');
            
            let forecastHTML = `<h4>5-Day Forecast for ${location}</h4><div class="weather-grid">`;
            
            forecast.forEach(day => {
                forecastHTML += `
                    <div class="weather-card">
                        <p class="weather-date">${new Date(day.date).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}</p>
                        <img src="https://openweathermap.org/img/w/${day.icon}.png" alt="${day.description}">
                        <p class="weather-temp">${day.temp}¬∞C</p>
                        <p class="weather-desc">${day.description}</p>
                        <small>üíß ${day.humidity}% | üí® ${day.wind_speed} m/s</small>
                    </div>
                `;
            });
            
            forecastHTML += '</div>';
            weatherResults.innerHTML = forecastHTML;
            weatherResults.classList.remove('hidden');
        }

        // Form submission
        document.getElementById('prediction-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!selectedCoordinates || !selectedState) {
                alert('Please select a location on the map to determine the State for prediction.');
                return;
            }
            
            const formData = {
                crop: document.getElementById('crop').value,
                season: document.getElementById('season').value,
                // Use selectedState from map, NOT from a form field
                state: selectedState, 
                area: parseFloat(document.getElementById('area').value),
                rainfall: parseFloat(document.getElementById('rainfall').value),
                fertilizer: parseFloat(document.getElementById('fertilizer').value),
                pesticide: parseFloat(document.getElementById('pesticide').value)
            };

            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                displayResults(data);
            } catch (error) {
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('prediction-card').classList.add('hidden');
                document.getElementById('recommendations-section').innerHTML = 
                    `<div class="error-box"><h3>Prediction Failed</h3><p>${error.message}</p></div>`;
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        });

        // Display prediction results
        function displayResults(data) {
            // Unhide prediction card if it was hidden by an error
            document.getElementById('prediction-card').classList.remove('hidden');

            // Update yield prediction
            document.getElementById('yield-value').textContent = data.predicted_yield;
            document.getElementById('yield-amount').textContent = data.predicted_yield;
            document.getElementById('confidence-range').textContent = 
                `${data.confidence_interval[0]} - ${data.confidence_interval[1]}`;
            document.getElementById('total-production').textContent = data.total_production;

            // Update recommendations
            const recommendationsContent = document.getElementById('recommendations-content');
            
            if (data.recommendations && typeof data.recommendations === 'object' && !data.recommendations.error) {
                let recommendationsHTML = '';
                
                Object.keys(data.recommendations).forEach(key => {
                    const section = data.recommendations[key];
                    const title = key.replace(/[_-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    recommendationsHTML += `<div class="recommendation-card">
                            <h4>${title}</h4>`;
                    
                    if (typeof section === 'object') {
                        recommendationsHTML += '<ul>';
                        Object.keys(section).forEach(subKey => {
                            const subTitle = subKey.replace(/[_-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            recommendationsHTML += `<li><strong>${subTitle}:</strong> ${section[subKey]}</li>`;
                        });
                        recommendationsHTML += '</ul>';
                    } else {
                        recommendationsHTML += `<p>${section}</p>`;
                    }
                    
                    recommendationsHTML += '</div>';
                });
                
                recommendationsContent.innerHTML = recommendationsHTML;
            } else {
                recommendationsContent.innerHTML = 
                    '<div class="warning-box"><p>ü§ñ AI recommendations are not available. Ensure the server is configured with a valid Gemini API key.</p></div>';
            }

            // Show results
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
            
            // Animate recommendation cards
            setTimeout(() => {
                document.querySelectorAll('.recommendation-card').forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '1';
                    }, index * 100);
                });
            }, 100);
        }

        // Weather button event listener
        document.getElementById('weather-btn').addEventListener('click', getWeatherForecast);

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupLocationSearch();
        });
    </script>
</body>
</html>
